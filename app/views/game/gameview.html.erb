<% if session[:lgin] %>
<script type="text/javascript">

      document.addEventListener("DOMContentLoaded", init, false);
      var ctx;
      var buttonstate=1;
      var resources = <%= @buildpts %>;
      function init(){
        ctx = document.getElementById("canvas").getContext("2d");
        var canvas = document.getElementById("canvas");
        canvas.addEventListener("mousedown", getPosition, false);
        update();
        periodicUpdate();
      }
      var res = 25
      var rectangle = function(rectx, recty, width, height, name, itemtype){
      	this.x = rectx;
      	this.y = recty;
      	this.w = width;
      	this.h = height;
      	this.name = name;
      	this.block = true;
        this.itemtype = itemtype;
      };
      var collidableObjects = [];

      <%
      count = 0
      @mapitems.each do |item| %>
      collidableObjects[<%= count %>] = new rectangle(<%= item.x %>,<%= item.y %>,25,25,"<%= item.user_id %>", <%= item.itemtype_id %>);

      <%
      count = count + 1
      end %>

      function getPosition(event)      {
        var x = new Number();
        var y = new Number();
        var canvas = document.getElementById("canvas");

        if (event.x != undefined && event.y != undefined)
        {
          x = event.x;
          y = event.y;
        }
        else // Firefox method to get the position
        {
          x = event.clientX + document.body.scrollLeft +
              document.documentElement.scrollLeft;
          y = event.clientY + document.body.scrollTop +
              document.documentElement.scrollTop;
        }

        x -= canvas.offsetLeft;
        y -= canvas.offsetTop;

        x = Math.floor(x / res) * res;
        y = Math.floor(y / res) * res;

        //alert("x: " + x + "  y: " + y);
        //getObject(x,y);
        if(x>=50 || y >= 200){
          if(buttonstate == 1){
            placeObject(x,y,2);
          }else if(buttonstate == 2){
            placeObject(x,y,1);
          }else if(buttonstate == 3){
            placeObject(x,y,3);
          }else {
            removeObject(x,y);
          }
        } else {
          if(y<50){
            //Button 1
            console.log("Button 1 selected");
            buttonstate = 1;
            drawInterface();
          }else if(y<100 && y>=50){
            //Button 2
            console.log("Button 2 selected");
            buttonstate = 2;
            drawInterface();
          } else if(y<150 && y>=100){
            //Button 2
            console.log("Button 3 selected");
            buttonstate = 3;
            drawInterface();
          } else {
            console.log("Button 0 selected");
            buttonstate = 0;
            drawInterface();
          }
        }
      }
      function drawInterface(){
        ctx.fillStyle="lightgrey";
        ctx.fillRect(0,0,50,200);
        if(buttonstate == 1){
          ctx.fillStyle="blue";
          ctx.fillRect(0,0,50,50);
        } else if(buttonstate == 2) {
          ctx.fillStyle="blue";
          ctx.fillRect(0,50,50,50);
        } else if(buttonstate == 3) {
          ctx.fillStyle="blue";
          ctx.fillRect(0,100,50,50);
        } else {
          ctx.fillStyle="blue";
          ctx.fillRect(0,150,50,50);
        }
        ctx.fillStyle="red";
        ctx.font="20px Arial";
        ctx.fillText(resources,500,20);
        ctx.fillText("Conn", 1, 25);
        ctx.fillText("Base", 1, 75);
        ctx.fillText("Turr", 1, 125)
        ctx.fillText("Rem", 1, 175);
      }
      function placeObject(x,y,t){
        if(resources>0){
          for(var i = 0; i < collidableObjects.length; i++){
            if(collidableObjects[i].x == x && collidableObjects[i].y == y){
              alert("Already something there");
              return;
            }
          }
          collidableObjects.push(new rectangle(x, y, 25, 25, "<%= @userid %>"));
          //console.log("Placed Object at " + x + "," + y);
          resources--;
          postPlace(x,y,t);
          //update();
        }
      }
      function removeObject(x,y){

        for(var i = 0; i < collidableObjects.length; i++){
          if(collidableObjects[i].x == x && collidableObjects[i].y == y){
              if(collidableObjects[i].name == "<%= @userid %>"){
              collidableObjects.splice(i, 1);
              resources++;
              removePlace(x,y);
              //update();
              return;
            } else {
              alert("Not yours");
            }
          }
        }
      }
      function getObject(x, y){
        for(var i=0; i<collidableObjects.length; i++){
          if(x > collidableObjects[i].x && x < collidableObjects[i].x + collidableObjects[i].w){
            if(y > collidableObjects[i].y && x < collidableObjects[i].y + collidableObjects[i].y){
              alert("HIT! at " + x + "," + y + " ");
            }
          }

        }
        //update();
      }
      function postPlace(x , y, t){
        console.log("placing item of type:" + t)
        post('/placeconnector', {
          x: x,
          y: y,
          t: t
        }, function(data) {

          });

          updatePts();
          updateState();
          //location.reload();

      };
      function removePlace(x , y){
        post('/remove', {
          x: x,
          y: y
        }, function(data) {

        }, function(error){
          console.log(error);
        });
          updatePts();
          updateState();
      };
      function update(){
        //console.log("Updating");
        ctx.clearRect(0,0,1080,760);
        for(var i = 0; i<collidableObjects.length; i++){
          //console.log("Draw");

          if(collidableObjects[i].name == "<%= @userid %>"){ctx.fillStyle="green";} else {ctx.fillStyle="red";}
          ctx.fillRect(collidableObjects[i].x, collidableObjects[i].y, collidableObjects[i].h, collidableObjects[i].w);
          if(collidableObjects[i].itemtype == 1){
            ctx.fillStyle="blue";
            ctx.fillRect(collidableObjects[i].x + 3, collidableObjects[i].y + 3, collidableObjects[i].h-6, collidableObjects[i].w-6);
          }
          if(collidableObjects[i].itemtype == 3){
            ctx.fillStyle="blue";
            ctx.fillRect(collidableObjects[i].x + 3, collidableObjects[i].y + 10, collidableObjects[i].h-6, collidableObjects[i].w-20);
            ctx.fillRect(collidableObjects[i].x + 10, collidableObjects[i].y + 3, collidableObjects[i].h-20, collidableObjects[i].w-6);
          }
        }


        drawInterface();

      }
      function updateState(){
        $.get('/getstate.json').success(function(mapdata){

          collidableObjects = [];
          for(var i = 0; i < mapdata.length; i++){

            collidableObjects.push(new rectangle(mapdata[i]['x'], mapdata[i]['y'], 25, 25, mapdata[i]['user_id'], mapdata[i]['itemtype_id']));
          }
          updatePts();
          update();
        }).fail(function(error){
          //alert(error);
          console.log("Error");
          console.log(error);
        });
      }
      function updatePts(){
        $.get('/getpts.json').success(function(data){
          console.log(data);
          resources = data;
        }).fail(function(error){
          //alert(error);
          console.log("Error");
          console.log(error);
      });
      }
      function periodicUpdate(){
        updateState();
        setTimeout(periodicUpdate, 5000);
      }
    </script>
<canvas id="canvas" width="1080" height="700" style="background-color: #000;"></canvas>
<% else %>
Login to play
<% end %>
